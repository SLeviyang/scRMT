# The scRMT package

This package provides code for analysis of single cell RNAseq using random matrix methods, as described in the preprint manuscript,
`https://www.biorxiv.org/content/10.1101/2023.06.28.546922v1`

The manuscript is currently under review.  All results in the manuscript can be genereted using this package as described below.  If you have any questions or encounter a bug, please open an issue through github or e-mail me at Sivan.Leviyang@georgetown.edu.


The package depends on the following external pacakges:  **dplyr, ggplot2, Seurat, splatter,          deSolve,          ggpubr
plyr,here,irlba,data.table,stringr,          Matrix,  umap, BiocNeighbors,latex2exp**. 
The full list can also be found in the DESCRIPTION file of the scRMT package.  To install scRMT, first make sure that all dependencies are installed.  Then install devtools, e.g. `install.packages("devtools")`, and execute the following commands in R

```r
library(devtools)
install_github("SLeviyang/scRMT")
```

The data used to generated some of the results in the mansucript is too big for GITHUB and instead must be accessed through zenodo.   After installing scRMT, download the file `data_template.zip` from Zenodo (DOI 10.5281/zenodo.8136144), place it in the scRMT directory and unzip it, then change the directory name to `data/`.   From there, all results in the manuscript can be generated by loading the package and executing the `make_everything()` function.   For example, if you open the package in Rstudio, you can then execute

```r
library(devtools)
load_all()
make_everything()
```

The scripts are parallized and require 3 to 4 nodes.  All results should be generated in about a day.   Below, I describe the individual steps needed to generate all the results.  

# Dataset Construction

The datasets are constructed by reading in raw data files and creating and saving Seurat objects as R rds files.  Raw data is included in the `data_template.zip` file.  To create all the Seurat objects needed for the manuscript analysis, unzip the file, rename the folder as `data/` and then execute `make_all_datasets()`. 

The scripts for constructing the datasets have a prefix `dataset_` and are listed below.   Within each script, there is a function with prefix `unprocessed` that generates and saves a Seurat object.   For the Kang et al dataset and insilico version the script also contains further functions to create subsampled datasets as described in the text.

1. `dataset_Intestine.R` : the Mead et al. dataset 
2. `dataset_HumanNasal.R`: Ordavas-Montanas et al dataset
3. `dataset_Kang.R`: Kang et al dataset
4. `dataset_Kang_insilico.R`: splatter generated dataset
5. `dataset_Zheng.R`:  Zheng et al dataset

# Perturbation Dataset Construction



For each dataset, we identify a collection of perturbation genes.   For each collection of perturbation genes, we construct a Seurat object.   To construct all the perturbation datasets call `make_perturbation_datasets()`.

The perturbation datasets are produced by a pipeline starting with the unprocessed datasets. Although not used in the manuscript,  within the pipeline there are different permutations that are of interest to the theory.

Permutation types:

1. *none* : the dataset is not altered
2. *orthogonal* : the rows (cells) of the baseline and perturbation expression matrices are permuted independently to create a baseline spike that is not correlated with the perturbation spike.
3. *single* : the genes of the baseline spike are idependently permuted, removing any baseline spikes.  the genes of the perturbation spike are permuted within the perturbation states, so that the perturbation module fits our model.
4. *module* : the baseline expression is not permuted, but the perturbation expression is permuted as in *single*.

In the manuscript, all the data shown are for *none*, except for one case of Mead et al which uses a *module* permutation.

Perturbation pipeline.   Each dataset goes through the following pipeline steps.  Each step corresponds to the constrution of a Seurat object.

1. *Identification of perturbation genes* : The perturbation genes are identified and ordered and a *base* object is created, which specifies the perturbation and baseline genes.   
2. *Permutations* : The base Seurat object is permuted as described above.
3. *Perturbation Gene Subsampling* : A specified number of perturbation genes are subsampled from the permutation Seurat object and a new Seurat object is created.

For the Kang et al. and splatter datasets this pipeline is executed in the *pipeline_Kang.R* script.   For all the other datasets its executed in the *pipeline_generic.R* script.  In all cases, the relevant functions have the respective prefixes *base*, *permutation*, *nISG*.  (For the non-Kang datasets, nISG subsamples perturbation genes which are not ISGs, but I used this nomenclature anyway for consistency.)

# True and Predicted Computations

For each perturbation dataset, I compute the true and predicted filtered signal strength and nearest neighbor metric.   These computations can be executed by calling `make_analysis()`.  

The analysis is accomplished by a pipeline that is applied to each dataset, composed of the following steps.

1. compute the bulk spectrum
2. compute the filtered signal 
3. compute the nearest neighbor metric

Here are the functions that actually do these computations.  These functions are called from inside wrapper functions that process the different datasets.

1. `spike_profile.analysis_util`:  Given an estimate of the bulk expression matrix, this function calls spectrode functions (see below) to compute the filtered signal.
2. `filtering_measure.analysis_util`: computes the filtered signal strength.
3. `nn_theory_none.analysis_util`: compute theoretical nearest neighbor metric without any assumptions on the baseline spieks
4. `nn_theory_homogeneous.analysis_util`: computes theoretical nearest neighbor metric assuming a homogeneous baseline.

# Manuscript Figures

The manuscript figures can be generated by a call to `make_figures()`.   The functions to make the figures can be found in three R scripts.

1. `manuscript_plots.R` : creates the splatter, Kang celltypes, and full dataset figures.
2. `manuscript_snr.R` : creates the SNR figures for the IFN module of the Kang celltypes.
3. `manuscript_odds_and_ends.R` : creates the figure for the BBP threshold and the figure for frequency bias in clustering.


